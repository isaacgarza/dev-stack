name: Release Please

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      force_release:
        description: 'Force create a release (skip conventional commit analysis)'
        required: false
        default: false
        type: boolean

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    name: Release Please
    runs-on: ubuntu-latest
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      version: ${{ steps.release.outputs.version }}
      pr: ${{ steps.release.outputs.pr }}
      releases_created: ${{ steps.release.outputs.releases_created }}
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Release Please
        id: release
        uses: google-github-actions/release-please-action@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          config-file: .release-please-config.json

      - name: Release Summary
        if: steps.release.outputs.releases_created
        run: |
          echo "ğŸ‰ Release created!"
          echo "Version: ${{ steps.release.outputs.tag_name }}"
          echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.release.outputs.tag_name }}"

  # Build and release (only when release is created)
  build-and-release:
    name: Build and Release Assets
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: ./.github/workflows/build-release.yml
    with:
      version: ${{ needs.release-please.outputs.version }}
      tag_name: ${{ needs.release-please.outputs.tag_name }}
    secrets: inherit

  # Package manager updates
  update-package-managers:
    name: Update Package Managers
    needs: [release-please, build-and-release]
    if: ${{ needs.release-please.outputs.release_created }}
    uses: ./.github/workflows/update-packages.yml
    with:
      version: ${{ needs.release-please.outputs.version }}
      tag_name: ${{ needs.release-please.outputs.tag_name }}
    secrets: inherit

  # Post-release notifications and cleanup
  post-release:
    name: Post-Release Tasks
    runs-on: ubuntu-latest
    needs: [release-please, build-and-release, update-package-managers]
    if: always() && needs.release-please.outputs.release_created
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Release Status Summary
        run: |
          echo "ğŸ“Š Release Status Summary for ${{ needs.release-please.outputs.tag_name }}"
          echo "================================"
          echo "âœ… Release Created: ${{ needs.release-please.outputs.release_created }}"
          echo "ğŸ“¦ Build Status: ${{ needs.build-and-release.result }}"
          echo "ğŸš€ Package Managers: ${{ needs.update-package-managers.result }}"
          echo ""
          echo "ğŸ”— Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ needs.release-please.outputs.tag_name }}"
          echo "ğŸ³ Docker Image: ghcr.io/${{ github.repository }}:${{ needs.release-please.outputs.version }}"

      - name: Notify Success
        if: needs.build-and-release.result == 'success' && needs.update-package-managers.result == 'success'
        run: |
          echo "ğŸ‰ Successfully released dev-stack ${{ needs.release-please.outputs.version }}"
          echo "All release tasks completed successfully!"

      - name: Notify Failure
        if: needs.build-and-release.result == 'failure' || needs.update-package-managers.result == 'failure'
        run: |
          echo "âš ï¸ Release ${{ needs.release-please.outputs.version }} completed with some failures"
          echo "Build Status: ${{ needs.build-and-release.result }}"
          echo "Package Manager Updates: ${{ needs.update-package-managers.result }}"
          echo "Please check the workflow logs for details"
