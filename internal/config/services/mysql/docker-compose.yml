services:
  mysql:
    image: mysql:8-oracle
    container_name: "${PROJECT_NAME:-dev-stack}-mysql"
    ports:
      - "${MYSQL_PORT:-3306}:3306"
    environment:
      - MYSQL_ROOT_PASSWORD=${MYSQL_PASSWORD:-password}
      - MYSQL_DATABASE=${MYSQL_DATABASE:-local_dev}
      - MYSQL_USER=${MYSQL_USER:-app_user}
      - MYSQL_PASSWORD=${MYSQL_PASSWORD:-password}
    volumes:
      - mysql-data:/var/lib/mysql
      - ./init-scripts:/docker-entrypoint-initdb.d
    restart: unless-stopped
    healthcheck:
      test:
        [
          "CMD",
          "mysqladmin",
          "ping",
          "-h",
          "localhost",
          "-u",
          "root",
          "-p${MYSQL_PASSWORD:-password}",
        ]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    networks:
      - dev-stack
    command: >
      --default-authentication-plugin=mysql_native_password
      --slow-query-log=1
      --slow-query-log-file=/var/log/mysql/slow.log
      --long-query-time=0.1
      --log-queries-not-using-indexes=1
      --max-connections=200
      --innodb-buffer-pool-size=256M

volumes:
  mysql-data:
    driver: local

networks:
  dev-stack:
    driver: bridge
    name: "${PROJECT_NAME:-dev-stack}-network"
